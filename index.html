<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Planner Food ¬∑ Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f4f5fb;
      --bg-alt: #eef1f7;
      --card-bg: #ffffff;
      --primary: #27ae60;
      --primary-soft: #d5f5e3;
      --primary-dark: #1e8449;
      --accent: #f39c12;
      --danger: #e74c3c;
      --text-main: #2d3436;
      --text-soft: #7f8c8d;
      --border-soft: #dde1ea;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #e8f8f5, #f4f5fb 55%, #ffffff);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: linear-gradient(180deg, #fdfefe 0, #f7f9fc 180px, #ffffff 320px);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    header {
      padding: 18px 18px 14px;
      background: radial-gradient(circle at top left, #2ecc71, #27ae60 55%, #1e8449);
      color: #fff;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.28);
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 18px solid rgba(255,255,255,0.12);
      top: -120px;
      right: -40px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }

    .logo-mark {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-circle {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    header h1 {
      font-size: 19px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    header p {
      margin-top: 4px;
      font-size: 13px;
      opacity: 0.9;
    }

    .week-nav {
      margin-top: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }

    .week-nav-controls {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 3px 8px;
    }

    .week-nav button {
      border: none;
      background: transparent;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
    }

    .week-label {
      font-weight: 500;
      font-size: 13px;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.16);
    }

    main {
      flex: 1;
      padding: 10px 14px 80px;
      overflow-y: auto;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin: 8px 2px 6px;
    }

    .day-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 10px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .day-card::before {
      content: "";
      position: absolute;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: radial-gradient(circle at top, rgba(39,174,96,0.08), transparent);
      right: -20px;
      top: -20px;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .day-name {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .day-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary-dark);
    }

    .empty-slot {
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-soft);
    }

    .primary-btn,
    .ghost-btn,
    .soft-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    .primary-btn {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 14px rgba(39,174,96,0.45);
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 6px rgba(39,174,96,0.45);
    }

    .ghost-btn {
      background: #fff;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
    }

    .soft-btn {
      background: var(--bg-alt);
      color: var(--text-soft);
      border: none;
    }

    .meal-summary {
      margin-top: 4px;
      display: grid;
      grid-template-columns: auto 1fr;
      grid-column-gap: 8px;
      font-size: 13px;
    }

    .meal-icon {
      font-size: 22px;
      display: flex;
      align-items: flex-start;
      padding-top: 3px;
    }

    .meal-main {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .meal-meta {
      font-size: 12px;
      color: var(--text-soft);
    }

    .day-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    /* Shopping list */
    .shopping-summary {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .shopping-summary b {
      display: block;
      margin-bottom: 2px;
    }

    .shopping-summary p {
      font-size: 12px;
      color: var(--text-soft);
    }

    .shopping-category {
      margin-bottom: 10px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
    }

    .shopping-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .shopping-category-header span.label {
      font-weight: 600;
    }

    .shopping-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border-soft);
    }

    .shopping-item:last-child {
      border-bottom: none;
    }

    .shopping-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .shopping-item small {
      color: var(--text-soft);
    }

    /* Bottom nav */
    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      max-width: 480px;
      width: 100%;
      background: rgba(255,255,255,0.96);
      border-top: 1px solid var(--border-soft);
      display: flex;
      justify-content: space-around;
      padding: 6px 0 8px;
      z-index: 30;
      backdrop-filter: blur(12px);
    }

    .bottom-nav button {
      flex: 1;
      background: none;
      border: none;
      padding: 4px 4px;
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .bottom-nav button span.icon {
      font-size: 18px;
    }

    .bottom-nav button.active {
      color: var(--primary);
      font-weight: 600;
    }

    /* Modales */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      background: #fff;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -10px 28px rgba(0,0,0,0.28);
      padding: 12px 14px 16px;
      overflow-y: auto;
      animation: slideUp 0.22s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(28px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      font-size: 16px;
    }

    .modal-header button {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 7px 12px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .meal-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      margin-bottom: 8px;
      overflow: hidden;
      font-size: 13px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.03);
    }

    .meal-card-hero {
      height: 140px;
      background: linear-gradient(135deg, #ffeaa7, #fab1a0);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .meal-card-body {
      padding: 8px 10px 10px;
    }

    .meal-card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f4f6f7;
      color: var(--text-soft);
    }

    .pill.primary {
      background: var(--primary-soft);
      color: var(--primary-dark);
    }

    .meal-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    /* Ficha detalle */
    .detail-hero {
      margin-bottom: 10px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: linear-gradient(135deg, #e84393, #fd79a8);
      color: #fff;
      padding: 14px 12px;
    }

    .detail-hero-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-hero-top h3 {
      font-size: 18px;
    }

    .detail-hero-emoji {
      font-size: 32px;
    }

    .detail-meta {
      margin-top: 8px;
      font-size: 13px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      opacity: 0.9;
    }

    .detail-section-title {
      margin: 10px 0 4px;
      font-size: 14px;
      font-weight: 600;
    }

    .detail-list {
      font-size: 13px;
      padding-left: 16px;
      margin-bottom: 4px;
    }

    .detail-list li {
      margin-bottom: 3px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f4f6f7;
      color: var(--text-soft);
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .error-banner {
      margin: 10px 2px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fdecea;
      color: #c0392b;
      font-size: 12px;
    }

    @media (min-width: 768px) {
      body { padding: 20px 0; }
      .app {
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 12px 40px rgba(0,0,0,0.2);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-top">
        <div class="logo-mark">
          <div class="logo-circle">ü•ó</div>
          <div>
            <h1>Planner Food</h1>
            <p>MVP conectado a Google Sheets</p>
          </div>
        </div>
        <span class="badge">v0.1 ¬∑ demo</span>
      </div>

      <div class="week-nav">
        <div class="week-nav-controls">
          <button id="prevWeekBtn">‚Äπ</button>
          <span class="week-label" id="weekLabel">Semana 1</span>
          <button id="nextWeekBtn">‚Ä∫</button>
        </div>
        <span style="font-size:12px;opacity:0.9;">1 plato por d√≠a</span>
      </div>
    </header>

    <main>
      <!-- Vista Semana -->
      <section id="weekView">
        <h2 class="section-title">Plan semanal</h2>
        <div id="daysContainer"></div>
      </section>

      <!-- Vista Lista -->
      <section id="shoppingView" style="display:none;">
        <h2 class="section-title">Lista de compras</h2>
        <div id="shoppingSummary" class="shopping-summary">
          <div>
            <b>Cargando datos...</b>
            <p>Esperando informaci√≥n de Google Sheets.</p>
          </div>
        </div>
        <div id="shoppingList"></div>
      </section>

      <div id="errorBox" class="error-banner" style="display:none;"></div>
    </main>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
      <button id="tabWeek" class="active">
        <span class="icon">üóìÔ∏è</span>
        <span>Semana</span>
      </button>
      <button id="tabShopping">
        <span class="icon">üõí</span>
        <span>Lista</span>
      </button>
    </nav>
  </div>

  <!-- Modal Selector de platos -->
  <div id="mealSelectorModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="mealSelectorTitle">Elegir plato</h2>
        <button onclick="closeMealSelector()">‚úï</button>
      </div>
      <input id="mealSearchInput" class="search-input" type="text" placeholder="Buscar plato..." />
      <div id="mealCardsContainer"></div>
    </div>
  </div>

  <!-- Modal Ficha del plato -->
  <div id="mealDetailModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="mealDetailTitle">Plato</h2>
        <button onclick="closeMealDetail()">‚úï</button>
      </div>
      <div id="mealDetailContent"></div>
    </div>
  </div>

  <script>
    // ===================== CONFIG GOOGLE SHEETS =====================

    const URL_PLATOS =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=0&single=true&output=csv";

    const URL_INGREDIENTES =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=688098548&single=true&output=csv";

    const URL_PASOS =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=1382429978&single=true&output=csv";

    // ===================== CSV PARSER ROBUSTO =====================

    function parseCSV(text) {
      const rows = [];
      let cur = "";
      let row = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === "," && !inQuotes) {
          row.push(cur);
          cur = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (cur !== "" || row.length) {
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }
          while (i + 1 < text.length && (text[i + 1] === "\n" || text[i + 1] === "\r")) {
            i++;
          }
        } else {
          cur += ch;
        }
      }
      if (cur !== "" || row.length) {
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) return [];

      const header = rows[0].map(h => h.trim());
      return rows
        .slice(1)
        .filter(r => r.length && r[0].trim() !== "")
        .map(r => {
          const obj = {};
          r.forEach((v, i) => {
            const key = header[i];
            obj[key] = (v ?? "").trim();
          });
          return obj;
        });
    }

    // ===================== ESTADO GLOBAL =====================

    let meals = [];
    const daysOfWeek = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
    let selectedMeals = Array(daysOfWeek.length).fill(null);
    let currentDayIndexForSelector = null;

    const weekView = document.getElementById("weekView");
    const shoppingView = document.getElementById("shoppingView");
    const tabWeekBtn = document.getElementById("tabWeek");
    const tabShoppingBtn = document.getElementById("tabShopping");
    const weekLabel = document.getElementById("weekLabel");
    const errorBox = document.getElementById("errorBox");
    let weekIndex = 1;

    // ===================== CARGA DE DATOS =====================

    async function loadMealsFromSheets() {
      const platos = await fetchCSV(URL_PLATOS);
      const ingredientes = await fetchCSV(URL_INGREDIENTES);
      const pasos = await fetchCSV(URL_PASOS);

      meals = platos.map(p => ({
        id: p.codigo,
        name: p.nombre_plato,
        emoji: "üçΩÔ∏è",
        time: Number(p["tiempo_preparacion(min)"] || 0),
        servings: Number(p.porciones || 0),
        difficulty: p.dificultad || "Sin definir",
        category: "General",
        url: p.url_pagina,
        ingredients: ingredientes
          .filter(i => i.codigo_plato === p.codigo)
          .map(i => ({
            category: i.tipo_ingrediente,
            name: i.ingrediente,
            unit: i.unidad_medida,
            quantity: i.cantidad === "" ? 0 : Number(i.cantidad)
          })),
        steps: pasos
          .filter(s => s.codigo === p.codigo)
          .sort((a, b) => Number(a.orden) - Number(b.orden))
          .map(s => s.indicacion)
      }));
    }

    // ===================== RENDER SEMANA =====================

    function renderWeekView() {
      const container = document.getElementById("daysContainer");
      container.innerHTML = "";

      daysOfWeek.forEach((dayName, index) => {
        const card = document.createElement("div");
        card.className = "day-card";

        const header = document.createElement("div");
        header.className = "day-header";
        header.innerHTML = `
          <div class="day-name">${dayName}</div>
          <div class="day-tag">1 plato</div>
        `;
        card.appendChild(header);

        const selectedId = selectedMeals[index];

        if (!selectedId) {
          const empty = document.createElement("div");
          empty.className = "empty-slot";
          empty.innerHTML = `<span>Sin plato asignado</span>`;
          const btn = document.createElement("button");
          btn.className = "primary-btn";
          btn.textContent = "Elegir plato";
          btn.onclick = () => openMealSelector(index);
          empty.appendChild(btn);
          card.appendChild(empty);
        } else {
          const meal = meals.find(m => m.id === selectedId);
          if (!meal) {
            selectedMeals[index] = null;
          } else {
            const summary = document.createElement("div");
            summary.className = "meal-summary";
            summary.innerHTML = `
              <div class="meal-icon">${meal.emoji}</div>
              <div>
                <div class="meal-main">${meal.name}</div>
                <div class="meal-meta">
                  ‚è± ${meal.time} min ¬∑ üçΩ ${meal.servings} porciones ¬∑ üö¶ ${meal.difficulty}
                </div>
              </div>
            `;
            card.appendChild(summary);

            const actions = document.createElement("div");
            actions.className = "day-actions";

            const detailBtn = document.createElement("button");
            detailBtn.className = "ghost-btn";
            detailBtn.textContent = "Ver ficha";
            detailBtn.onclick = () => openMealDetail(meal.id);

            const changeBtn = document.createElement("button");
            changeBtn.className = "primary-btn";
            changeBtn.textContent = "Cambiar";
            changeBtn.onclick = () => openMealSelector(index);

            actions.appendChild(detailBtn);
            actions.appendChild(changeBtn);
            card.appendChild(actions);
          }
        }

        container.appendChild(card);
      });
    }

    // ===================== SELECTOR DE PLATOS =====================

    function openMealSelector(dayIndex) {
      currentDayIndexForSelector = dayIndex;
      document.getElementById("mealSelectorTitle").textContent =
        "Elegir plato ‚Äì " + daysOfWeek[dayIndex];
      document.getElementById("mealSearchInput").value = "";
      renderMealSelectorList("");
      document.getElementById("mealSelectorModal").style.display = "flex";
    }

    function closeMealSelector() {
      document.getElementById("mealSelectorModal").style.display = "none";
      currentDayIndexForSelector = null;
    }

    function renderMealSelectorList(query) {
      const container = document.getElementById("mealCardsContainer");
      container.innerHTML = "";

      const filtered = meals.filter(m =>
        m.name.toLowerCase().includes(query.toLowerCase())
      );

      filtered.forEach(meal => {
        const card = document.createElement("div");
        card.className = "meal-card";

        const hero = document.createElement("div");
        hero.className = "meal-card-hero";
        hero.textContent = meal.emoji;

        const body = document.createElement("div");
        body.className = "meal-card-body";

        const title = document.createElement("div");
        title.className = "meal-card-title";
        title.textContent = meal.name;

        const pills = document.createElement("div");
        pills.className = "pill-row";
        pills.innerHTML = `
          <span class="pill primary">‚è± ${meal.time} min</span>
          <span class="pill">üçΩ ${meal.servings} porciones</span>
          <span class="pill">üö¶ ${meal.difficulty}</span>
          <span class="pill">üè∑Ô∏è ${meal.category}</span>
        `;

        const actions = document.createElement("div");
        actions.className = "meal-card-actions";

        const detailBtn = document.createElement("button");
        detailBtn.className = "ghost-btn";
        detailBtn.textContent = "Ficha";
        detailBtn.onclick = () => openMealDetail(meal.id);

        const selectBtn = document.createElement("button");
        selectBtn.className = "primary-btn";
        selectBtn.textContent = "Elegir";
        selectBtn.onclick = () => {
          if (currentDayIndexForSelector !== null) {
            selectedMeals[currentDayIndexForSelector] = meal.id;
            renderWeekView();
            updateShoppingView();
            closeMealSelector();
          }
        };

        actions.appendChild(detailBtn);
        actions.appendChild(selectBtn);

        body.appendChild(title);
        body.appendChild(pills);
        body.appendChild(actions);

        card.appendChild(hero);
        card.appendChild(body);

        container.appendChild(card);
      });

      if (!filtered.length) {
        const msg = document.createElement("p");
        msg.style.fontSize = "13px";
        msg.style.color = "var(--text-soft)";
        msg.textContent = "No se encontraron platos para ese t√©rmino.";
        container.appendChild(msg);
      }
    }

    document.getElementById("mealSearchInput").addEventListener("input", e => {
      renderMealSelectorList(e.target.value);
    });

    // ===================== FICHA DEL PLATO =====================

    function openMealDetail(mealId) {
      const meal = meals.find(m => m.id === mealId);
      if (!meal) return;

      document.getElementById("mealDetailTitle").textContent = meal.name;
      const content = document.getElementById("mealDetailContent");

      const ingredientsHtml = meal.ingredients
        .map(ing => `<li>${ing.name} ‚Äî ${ing.quantity} ${ing.unit}</li>`)
        .join("");

      const stepsHtml = meal.steps
        .map(step => `<li>${step}</li>`)
        .join("");

      content.innerHTML = `
        <div class="detail-hero">
          <div class="detail-hero-top">
            <h3>${meal.name}</h3>
            <div class="detail-hero-emoji">${meal.emoji}</div>
          </div>
          <div class="detail-meta">
            <span>‚è± ${meal.time} min</span>
            <span>üçΩ ${meal.servings} porciones</span>
            <span>üö¶ ${meal.difficulty}</span>
          </div>
        </div>
        <div style="margin-bottom:6px;">
          <span class="chip">üè∑Ô∏è Categor√≠a: ${meal.category}</span>
          <span class="chip">üìÑ Fuente: Buenazo</span>
        </div>
        <h3 class="detail-section-title">Ingredientes</h3>
        <ul class="detail-list">
          ${ingredientsHtml}
        </ul>
        <h3 class="detail-section-title">Preparaci√≥n</h3>
        <ol class="detail-list">
          ${stepsHtml}
        </ol>
        <h3 class="detail-section-title">Receta original</h3>
        <p style="font-size:13px;margin-bottom:6px;">
          Puedes revisar la receta completa en la p√°gina de origen:
        </p>
        <button class="primary-btn" onclick="window.open('${meal.url}','_blank')">
          Abrir en Buenazo
        </button>
      `;

      document.getElementById("mealDetailModal").style.display = "flex";
    }

    function closeMealDetail() {
      document.getElementById("mealDetailModal").style.display = "none";
    }

    // ===================== LISTA DE COMPRAS =====================

    function updateShoppingView() {
      const summaryBox = document.getElementById("shoppingSummary");
      const listContainer = document.getElementById("shoppingList");

      const selectedIds = selectedMeals.filter(id => id !== null);
      listContainer.innerHTML = "";

      if (!selectedIds.length) {
        summaryBox.innerHTML = `
          <div>
            <b>Sin platos seleccionados</b>
            <p>Elige platos en la vista "Semana" para generar la lista.</p>
          </div>
        `;
        return;
      }

      const uniqueSelected = [...new Set(selectedIds)];
      summaryBox.innerHTML = `
        <div>
          <b>${uniqueSelected.length} platos seleccionados</b>
          <p>Lista consolidada de ingredientes para toda la semana.</p>
        </div>
        <button class="soft-btn" onclick="alert('En el siguiente paso del MVP esto exportar√≠a a PDF o Excel üòÑ')">
          Exportar
        </button>
      `;

      const aggregate = {};
      selectedIds.forEach(id => {
        const meal = meals.find(m => m.id === id);
        if (!meal) return;
        meal.ingredients.forEach(ing => {
          const key = `${ing.name}|${ing.unit}`;
          if (!aggregate[key]) {
            aggregate[key] = {
              name: ing.name,
              unit: ing.unit,
              quantity: 0,
              category: ing.category
            };
          }
          aggregate[key].quantity += ing.quantity;
        });
      });

      const byCategory = {};
      Object.values(aggregate).forEach(item => {
        const cat = item.category || "Otros";
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(item);
      });

      Object.keys(byCategory).forEach(cat => {
        const catBox = document.createElement("div");
        catBox.className = "shopping-category";

        const header = document.createElement("div");
        header.className = "shopping-category-header";
        header.innerHTML = `
          <span class="label">${cat}</span>
          <span style="font-size:12px;color:var(--text-soft);">
            ${byCategory[cat].length} ingredientes
          </span>
        `;
        catBox.appendChild(header);

        byCategory[cat].forEach(item => {
          const row = document.createElement("div");
          row.className = "shopping-item";

          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          label.appendChild(checkbox);
          const text = document.createElement("span");
          text.textContent = item.name;
          label.appendChild(text);

          const qty = document.createElement("small");
          qty.textContent = `${item.quantity} ${item.unit}`;

          row.appendChild(label);
          row.appendChild(qty);

          catBox.appendChild(row);
        });

        listContainer.appendChild(catBox);
      });
    }

    // ===================== NAV TABS =====================

    tabWeekBtn.addEventListener("click", () => {
      tabWeekBtn.classList.add("active");
      tabShoppingBtn.classList.remove("active");
      weekView.style.display = "";
      shoppingView.style.display = "none";
    });

    tabShoppingBtn.addEventListener("click", () => {
      tabShoppingBtn.classList.add("active");
      tabWeekBtn.classList.remove("active");
      shoppingView.style.display = "";
      weekView.style.display = "none";
      updateShoppingView();
    });

    document.getElementById("prevWeekBtn").onclick = () => {
      if (weekIndex > 1) weekIndex--;
      weekLabel.textContent = "Semana " + weekIndex;
    };

    document.getElementById("nextWeekBtn").onclick = () => {
      weekIndex++;
      weekLabel.textContent = "Semana " + weekIndex;
    };

    // ===================== INIT =====================

    (async () => {
      try {
        await loadMealsFromSheets();
        renderWeekView();
        updateShoppingView();
      } catch (err) {
        console.error(err);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Error cargando datos desde Google Sheets. Verifica que las hojas est√©n publicadas como CSV y accesibles p√∫blicamente.";
      }
    })();
  </script>
</body>
</html>
