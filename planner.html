<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Planificador de Platos Semanal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f6fa;
      --card-bg: #ffffff;
      --primary: #2ecc71;
      --primary-soft: #d5f5e3;
      --accent: #f39c12;
      --text-main: #2c3e50;
      --text-soft: #7f8c8d;
      --border-soft: #e0e0e0;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 6px 18px rgba(0,0,0,0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 420px;
      min-height: 100vh;
      background: #fdfdfd;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px 20px 10px;
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    header p {
      font-size: 13px;
      opacity: 0.9;
    }

    .week-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 13px;
    }

    .week-nav button {
      border: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border-radius: 999px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 13px;
    }

    .week-nav span {
      font-weight: 500;
    }

    main {
      flex: 1;
      padding: 12px 14px 70px;
      overflow-y: auto;
    }

    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      max-width: 420px;
      width: 100%;
      background: #fff;
      border-top: 1px solid var(--border-soft);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 20;
    }

    .bottom-nav button {
      flex: 1;
      background: none;
      border: none;
      padding: 6px 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .bottom-nav button span.icon {
      font-size: 18px;
    }

    .bottom-nav button.active {
      color: var(--primary);
      font-weight: 600;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 8px 2px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .day-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 10px;
      margin-bottom: 10px;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .day-name {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
    }

    .day-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .empty-slot {
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }

    .primary-btn,
    .ghost-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .primary-btn {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
    }

    .ghost-btn {
      background: #fff;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
    }

    .meal-summary {
      margin-top: 4px;
      display: grid;
      grid-template-columns: auto 1fr;
      grid-column-gap: 8px;
      font-size: 13px;
    }

    .meal-icon {
      font-size: 22px;
    }

    .meal-main {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .meal-meta {
      font-size: 12px;
      color: var(--text-soft);
    }

    .day-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .shopping-summary {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shopping-category {
      margin-bottom: 10px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
    }

    .shopping-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .shopping-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border-soft);
    }

    .shopping-item:last-child {
      border-bottom: none;
    }

    .shopping-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .shopping-item small {
      color: var(--text-soft);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 30;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      background: #fff;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.2);
      padding: 12px 14px 16px;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      font-size: 16px;
    }

    .modal-header button {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 7px 12px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .meal-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      margin-bottom: 8px;
      overflow: hidden;
      font-size: 13px;
    }

    .meal-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
      background: #ddd;
    }

    .meal-card-body {
      padding: 8px 10px 10px;
    }

    .meal-card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f4f6f7;
      color: var(--text-soft);
    }

    .pill.primary {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .meal-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .detail-hero {
      margin-bottom: 10px;
    }

    .detail-hero img {
      width: 100%;
      height: 190px;
      object-fit: cover;
      border-radius: var(--radius-md);
    }

    .detail-meta {
      margin-top: 6px;
      font-size: 13px;
    }

    .detail-meta span {
      margin-right: 8px;
      color: var(--text-soft);
    }

    .detail-section-title {
      margin: 10px 0 4px;
      font-size: 14px;
      font-weight: 600;
    }

    .detail-list {
      font-size: 13px;
      padding-left: 16px;
    }

    .detail-list li {
      margin-bottom: 3px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f4f6f7;
      color: var(--text-soft);
    }

    @media (min-width: 768px) {
      body {
        padding: 20px 0;
      }

      .app {
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Planificador semanal</h1>
      <p>Elige tus platos, genera la lista de compras y consulta las fichas.</p>
      <div class="week-nav">
        <button id="prevWeekBtn">‚óÄ</button>
        <span id="weekLabel">Semana 1</span>
        <button id="nextWeekBtn">‚ñ∂</button>
      </div>
    </header>

    <main>
      <!-- Vista Semana -->
      <section id="weekView">
        <h2 class="section-title">Platos por d√≠a</h2>
        <div id="daysContainer"></div>
      </section>

      <!-- Vista Lista -->
      <section id="shoppingView" style="display:none;">
        <h2 class="section-title">Lista de compras</h2>
        <div id="shoppingSummary" class="shopping-summary">
          <div>
            <b>Cargando datos‚Ä¶</b>
            <p style="font-size:12px;color:var(--text-soft);">
              Espera un momento mientras leemos tus recetas desde Google Sheets.
            </p>
          </div>
        </div>
        <div id="shoppingList"></div>
      </section>
    </main>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
      <button id="tabWeek" class="active">
        <span class="icon">üóìÔ∏è</span>
        Semana
      </button>
      <button id="tabShopping">
        <span class="icon">üõí</span>
        Lista
      </button>
    </nav>
  </div>

  <!-- Modal Selector de platos -->
  <div id="mealSelectorModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="mealSelectorTitle">Elegir plato</h2>
        <button onclick="closeMealSelector()">‚úï</button>
      </div>
      <input id="mealSearchInput" class="search-input" type="text" placeholder="Buscar plato..." />
      <div id="mealCardsContainer"></div>
    </div>
  </div>

  <!-- Modal Ficha del plato -->
  <div id="mealDetailModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="mealDetailTitle">Plato</h2>
        <button onclick="closeMealDetail()">‚úï</button>
      </div>
      <div id="mealDetailContent"></div>
    </div>
  </div>

  <script>
    // ===================== GLOBAL STATE =====================
    let meals = [];
    const daysOfWeek = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
    let selectedMeals = Array(daysOfWeek.length).fill(null);
    let currentDayIndexForSelector = null;

    const weekView = document.getElementById("weekView");
    const shoppingView = document.getElementById("shoppingView");
    const tabWeekBtn = document.getElementById("tabWeek");
    const tabShoppingBtn = document.getElementById("tabShopping");
    const weekLabel = document.getElementById("weekLabel");
    let weekIndex = 1;

    // ===================== GOOGLE SHEETS CONFIG =====================

    const URL_PLATOS =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=0&single=true&output=csv";

    const URL_INGREDIENTES =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=688098548&single=true&output=csv";

    const URL_PASOS =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUhilXj9P1Kh1JrpnSJLCT0TM_XBpMM-d3fbw17RREop6Jcz73U_aqmgM-dL5EO8T5Tr_8qG_RgUrx/pub?gid=1382429978&single=true&output=csv";

    // ===================== CSV PARSER ROBUSTO =====================
    // Soporta comas dentro de comillas (ej: "Mezcla, prueba, sirve")
    function parseCSV(text) {
      const rows = [];
      let cur = "";
      let row = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i+1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === "," && !inQuotes) {
          row.push(cur);
          cur = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (cur !== "" || row.length) {
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }
          // saltar \r\n dobles
          while (i+1 < text.length && (text[i+1] === "\n" || text[i+1] === "\r")) {
            i++;
          }
        } else {
          cur += ch;
        }
      }
      if (cur !== "" || row.length) {
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = parseCSV(text);

      if (!rows.length) return [];

      const header = rows[0].map(h => h.trim());
      return rows
        .slice(1)
        .filter(r => r.length && r[0].trim() !== "")
        .map(r => {
          const obj = {};
          r.forEach((v,i) => {
            const key = header[i];
            obj[key] = (v ?? "").trim();
          });
          return obj;
        });
    }

    // ===================== LOAD & MAP SHEETS =====================
    async function loadMealsFromSheets() {
      const platos = await fetchCSV(URL_PLATOS);
      const ingredientes = await fetchCSV(URL_INGREDIENTES);
      const pasos = await fetchCSV(URL_PASOS);

      meals = platos.map(p => ({
        id: p.codigo,                          // ID REAL
        name: p.nombre_plato,                  // Nombre
        emoji: "üçΩÔ∏è",                           // Default
        time: Number(p["tiempo_preparacion(min)"] || 0),
        servings: Number(p.porciones || 0),
        difficulty: p.dificultad || "Sin definir",
        category: "General",                   // Tu sheet no trae categor√≠a
        youtubeUrl: p.url_pagina,              // Usamos URL de p√°gina como "video/imagen"

        // INGREDIENTES
        ingredients: ingredientes
          .filter(i => i.codigo_plato === p.codigo)
          .map(i => ({
            category: i.tipo_ingrediente,
            name: i.ingrediente,
            unit: i.unidad_medida,
            quantity: i.cantidad === "" ? 0 : Number(i.cantidad)
          })),

        // PASOS / INDICACIONES
        steps: pasos
          .filter(s => s.codigo === p.codigo)
          .sort((a,b)=> Number(a.orden) - Number(b.orden))
          .map(s => s.indicacion)
      }));
    }

    // ===================== UTILIDADES UI =====================

    function getYoutubeThumbnail(url) {
      if (!url) return "https://via.placeholder.com/640x360?text=Plato";
      const match = url.match(/v=([^&]+)/);
      if (!match) return "https://via.placeholder.com/640x360?text=Plato";
      const id = match[1];
      return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
    }

    // RENDER SEMANA
    function renderWeekView() {
      const container = document.getElementById("daysContainer");
      container.innerHTML = "";

      daysOfWeek.forEach((dayName, index) => {
        const dayCard = document.createElement("div");
        dayCard.className = "day-card";

        const header = document.createElement("div");
        header.className = "day-header";
        header.innerHTML = `
          <div class="day-name">${dayName}</div>
          <div class="day-tag">1 plato / d√≠a</div>
        `;
        dayCard.appendChild(header);

        const selectedId = selectedMeals[index];

        if (!selectedId) {
          const empty = document.createElement("div");
          empty.className = "empty-slot";
          empty.innerHTML = `<span>Sin plato asignado</span>`;
          const btn = document.createElement("button");
          btn.className = "primary-btn";
          btn.textContent = "Elegir plato";
          btn.onclick = () => openMealSelector(index);
          empty.appendChild(btn);
          dayCard.appendChild(empty);
        } else {
          const meal = meals.find(m => m.id === selectedId);
          if (!meal) {
            selectedMeals[index] = null;
            return;
          }

          const summary = document.createElement("div");
          summary.className = "meal-summary";
          summary.innerHTML = `
            <div class="meal-icon">${meal.emoji}</div>
            <div>
              <div class="meal-main">${meal.name}</div>
              <div class="meal-meta">
                ‚è± ${meal.time} min ¬∑ üçΩ ${meal.servings} porciones ¬∑ üö¶ ${meal.difficulty}
              </div>
            </div>
          `;
          dayCard.appendChild(summary);

          const actions = document.createElement("div");
          actions.className = "day-actions";

          const detailBtn = document.createElement("button");
          detailBtn.className = "ghost-btn";
          detailBtn.textContent = "Ver ficha";
          detailBtn.onclick = () => openMealDetail(meal.id);

          const changeBtn = document.createElement("button");
          changeBtn.className = "primary-btn";
          changeBtn.textContent = "Cambiar plato";
          changeBtn.onclick = () => openMealSelector(index);

          actions.appendChild(detailBtn);
          actions.appendChild(changeBtn);
          dayCard.appendChild(actions);
        }

        container.appendChild(dayCard);
      });
    }

    // SELECTOR DE PLATOS
    function openMealSelector(dayIndex) {
      currentDayIndexForSelector = dayIndex;
      document.getElementById("mealSelectorTitle").textContent =
        `Elegir plato ‚Äì ${daysOfWeek[dayIndex]}`;
      document.getElementById("mealSearchInput").value = "";
      renderMealSelectorList("");
      document.getElementById("mealSelectorModal").style.display = "flex";
    }

    function closeMealSelector() {
      document.getElementById("mealSelectorModal").style.display = "none";
      currentDayIndexForSelector = null;
    }

    function renderMealSelectorList(query) {
      const container = document.getElementById("mealCardsContainer");
      container.innerHTML = "";

      const filtered = meals.filter(m =>
        m.name.toLowerCase().includes(query.toLowerCase())
      );

      filtered.forEach(meal => {
        const card = document.createElement("div");
        card.className = "meal-card";

        const img = document.createElement("img");
        img.src = getYoutubeThumbnail(meal.youtubeUrl);
        img.alt = meal.name;

        const body = document.createElement("div");
        body.className = "meal-card-body";

        const title = document.createElement("div");
        title.className = "meal-card-title";
        title.textContent = `${meal.emoji} ${meal.name}`;

        const pills = document.createElement("div");
        pills.className = "pill-row";
        pills.innerHTML = `
          <span class="pill primary">‚è± ${meal.time} min</span>
          <span class="pill">üçΩ ${meal.servings} porciones</span>
          <span class="pill">üö¶ ${meal.difficulty}</span>
          <span class="pill">üè∑Ô∏è ${meal.category}</span>
        `;

        const actions = document.createElement("div");
        actions.className = "meal-card-actions";

        const detailBtn = document.createElement("button");
        detailBtn.className = "ghost-btn";
        detailBtn.textContent = "Ver ficha";
        detailBtn.onclick = () => openMealDetail(meal.id);

        const selectBtn = document.createElement("button");
        selectBtn.className = "primary-btn";
        selectBtn.textContent = "Elegir";
        selectBtn.onclick = () => {
          if (currentDayIndexForSelector !== null) {
            selectedMeals[currentDayIndexForSelector] = meal.id;
            renderWeekView();
            updateShoppingView();
            closeMealSelector();
          }
        };

        actions.appendChild(detailBtn);
        actions.appendChild(selectBtn);

        body.appendChild(title);
        body.appendChild(pills);
        body.appendChild(actions);

        card.appendChild(img);
        card.appendChild(body);

        container.appendChild(card);
      });

      if (filtered.length === 0) {
        const emptyLabel = document.createElement("p");
        emptyLabel.style.fontSize = "13px";
        emptyLabel.style.color = "var(--text-soft)";
        emptyLabel.textContent = "No se encontraron platos para ese t√©rmino.";
        container.appendChild(emptyLabel);
      }
    }

    document.getElementById("mealSearchInput").addEventListener("input", (e) => {
      renderMealSelectorList(e.target.value);
    });

    // FICHA DEL PLATO
    function openMealDetail(mealId) {
      const meal = meals.find(m => m.id === mealId);
      if (!meal) return;

      document.getElementById("mealDetailTitle").textContent = meal.name;
      const content = document.getElementById("mealDetailContent");
      const thumb = getYoutubeThumbnail(meal.youtubeUrl);

      const stepsHtml = meal.steps
        .map(step => `<li>${step}</li>`)
        .join("");

      const ingredientsHtml = meal.ingredients
        .map(ing => `<li>${ing.name} ‚Äî ${ing.quantity} ${ing.unit}</li>`)
        .join("");

      content.innerHTML = `
        <div class="detail-hero">
          <img src="${thumb}" alt="${meal.name}" />
          <div class="detail-meta">
            <span>‚è± ${meal.time} min</span>
            <span>üçΩ ${meal.servings} porciones</span>
            <span>üö¶ ${meal.difficulty}</span>
          </div>
        </div>
        <div class="chip">üè∑Ô∏è Categor√≠a: ${meal.category}</div>
        <h3 class="detail-section-title">Ingredientes</h3>
        <ul class="detail-list">
          ${ingredientsHtml}
        </ul>
        <h3 class="detail-section-title">Preparaci√≥n</h3>
        <ol class="detail-list">
          ${stepsHtml}
        </ol>
        <h3 class="detail-section-title">Video / P√°gina</h3>
        <p style="font-size:13px;margin-bottom:4px;">Puedes ver la receta completa aqu√≠:</p>
        <button class="primary-btn" onclick="window.open('${meal.youtubeUrl}','_blank')">
          ‚ñ∂ Abrir receta
        </button>
      `;

      document.getElementById("mealDetailModal").style.display = "flex";
    }

    function closeMealDetail() {
      document.getElementById("mealDetailModal").style.display = "none";
    }

    // LISTA DE COMPRAS
    function updateShoppingView() {
      const summaryBox = document.getElementById("shoppingSummary");
      const listContainer = document.getElementById("shoppingList");

      const selectedIds = selectedMeals.filter(id => id !== null);
      listContainer.innerHTML = "";

      if (selectedIds.length === 0) {
        summaryBox.innerHTML = `
          <div>
            <b>Sin platos seleccionados</b>
            <p style="font-size:12px;color:var(--text-soft);">
              Elige al menos un plato en la vista de semana.
            </p>
          </div>
        `;
        return;
      }

      const uniqueSelectedMeals = [...new Set(selectedIds)];
      summaryBox.innerHTML = `
        <div>
          <b>${uniqueSelectedMeals.length} platos seleccionados</b>
          <p style="font-size:12px;color:var(--text-soft);">
            Lista consolidada seg√∫n todos los ingredientes de la semana.
          </p>
        </div>
        <button class="ghost-btn" onclick="alert('Aqu√≠ podr√≠as exportar a PDF/Excel en una versi√≥n MVP siguiente ü§ì')">
          Exportar
        </button>
      `;

      const aggregate = {};
      selectedIds.forEach(id => {
        const meal = meals.find(m => m.id === id);
        if (!meal) return;
        meal.ingredients.forEach(ing => {
          const key = `${ing.name}|${ing.unit}`;
          if (!aggregate[key]) {
            aggregate[key] = {
              name: ing.name,
              unit: ing.unit,
              quantity: 0,
              category: ing.category
            };
          }
          aggregate[key].quantity += ing.quantity;
        });
      });

      const byCategory = {};
      Object.values(aggregate).forEach(item => {
        const cat = item.category || "Otros";
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(item);
      });

      Object.keys(byCategory).forEach(cat => {
        const catBox = document.createElement("div");
        catBox.className = "shopping-category";

        const header = document.createElement("div");
        header.className = "shopping-category-header";
        header.innerHTML = `
          <span class="label">${cat}</span>
          <span style="font-size:12px;color:var(--text-soft);">
            ${byCategory[cat].length} √≠tems
          </span>
        `;
        catBox.appendChild(header);

        byCategory[cat].forEach(item => {
          const row = document.createElement("div");
          row.className = "shopping-item";

          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          label.appendChild(checkbox);
          const text = document.createElement("span");
          text.textContent = item.name;
          label.appendChild(text);

          const qty = document.createElement("small");
          qty.textContent = `${item.quantity} ${item.unit}`;

          row.appendChild(label);
          row.appendChild(qty);

          catBox.appendChild(row);
        });

        listContainer.appendChild(catBox);
      });
    }

    // NAV TABS
    tabWeekBtn.addEventListener("click", () => {
      tabWeekBtn.classList.add("active");
      tabShoppingBtn.classList.remove("active");
      weekView.style.display = "";
      shoppingView.style.display = "none";
    });

    tabShoppingBtn.addEventListener("click", () => {
      tabShoppingBtn.classList.add("active");
      tabWeekBtn.classList.remove("active");
      shoppingView.style.display = "";
      weekView.style.display = "none";
      updateShoppingView();
    });

    document.getElementById("prevWeekBtn").onclick = () => {
      if (weekIndex > 1) weekIndex--;
      weekLabel.textContent = `Semana ${weekIndex}`;
    };
    document.getElementById("nextWeekBtn").onclick = () => {
      weekIndex++;
      weekLabel.textContent = `Semana ${weekIndex}`;
    };

    // ===================== INIT =====================
    (async () => {
      try {
        await loadMealsFromSheets();
        renderWeekView();
        updateShoppingView();
      } catch (e) {
        console.error(e);
        const summaryBox = document.getElementById("shoppingSummary");
        summaryBox.innerHTML = `
          <div>
            <b>Error cargando datos</b>
            <p style="font-size:12px;color:var(--danger);">
              Revisa que tus hojas de Google est√©n publicadas como CSV.
            </p>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
